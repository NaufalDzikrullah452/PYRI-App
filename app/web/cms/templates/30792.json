{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  let { tipe, e, user_id } = req?.body;\n\n  let res = \"Failure\";\n  let snaptoken = \"\";\n\n  if (e === \"Subscribe\") {\n    console.log(tipe);\n\n    if (tipe == \"Bibliophile\") {\n      await initializeSnap(60000, tipe, user_id, 1);\n    } else if (tipe == \"Bibliomania\") {\n      await initializeSnap(540000, tipe, user_id, 2);\n    } else if (tipe == \"Bibliognost\") {\n      await initializeSnap(324000, tipe, user_id, 3);\n    }\n\n    res = \"Successfully subscribe\";\n  }\n\n  async function initializeSnap(amount, tipe, user_id, plan_id) {\n    var myHeaders = new Headers();\n    myHeaders.append(\"Accept\", \"application/json\");\n    myHeaders.append(\"Content-Type\", \"application/json\");\n\n    var authorizedKey = btoa(\"SB-Mid-server-eGdirwy9CXAYIFfTour1KZOW:\");\n    myHeaders.append(\"Authorization\", `Basic ${authorizedKey}`);\n\n    var randomizedId =\n      Math.floor(Math.random() * 100).toString() +\n      Math.floor(Math.random() * 100).toString() +\n      Math.floor(Math.random() * 100).toString() +\n      Math.floor(Math.random() * 100).toString() +\n      Math.floor(Math.random() * 100).toString() +\n      Math.floor(Math.random() * 100).toString();\n\n    var customer = await getCustomerDetails(user_id);\n\n    var raw = {\n      transaction_details: {\n        order_id: \"ORDER-\" + randomizedId,\n        gross_amount: amount,\n      },\n      credit_card: {\n        secure: true,\n        save_card: true,\n      },\n      user_id: user_id,\n      plan_id: plan_id,\n      item_details: [\n        {\n          id: \"Plan\",\n          price: amount,\n          quantity: 1,\n          name: tipe,\n          merchant_name: \"Pyri\",\n        },\n      ],\n      customer_details: {\n        first_name: customer.user_name,\n        email: customer.user_email,\n      },\n    };\n\n    console.log(\"User Id\", user_id, \"Plan id\", plan_id);\n\n    var requestOptions = {\n      method: \"POST\",\n      headers: myHeaders,\n      body: JSON.stringify(raw),\n    };\n\n    var result;\n\n    await fetch(\n      \"https://app.sandbox.midtrans.com/snap/v1/transactions\",\n      requestOptions\n    )\n      .then((response) => response.json())\n      .then((data) => (result = data))\n      .then(() => (snaptoken = result.token))\n      .catch((error) => console.log(\"error\", error));\n  }\n\n  async function getCustomerDetails(user_id) {\n    let users = await db.users.findFirst({\n      where: {\n        user_id: user_id,\n      },\n    });\n    return users;\n  }\n\n  reply.send({\n    res: res,\n    tipe,\n    e,\n    snaptoken,\n  })\n}","figma":{}},"title":"handler-premium","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"54643","slug":"/api/premium","site":"*","id":"30792"}